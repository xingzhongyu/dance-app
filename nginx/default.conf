# nginx/default.conf (最终修正版)

server {
    listen 80;
    server_name omicsml.ai;
    # server_name sdu-112;
    client_max_body_size 1000M; 

    # 根路径重定向
    location = / {
        return 301 $scheme://$http_host/dance/;
    }

    # 1. 精确匹配 /dance (不带斜杠)
    #    它的唯一任务就是加上斜杠并正确重定向。
    location = /dance {
        return 301 $scheme://$http_host/dance/;
    }

    # 2. 匹配所有 /dance/ 开头的路径 (包括 /dance/login/, /dance/atlas/, etc.)
    #    这个 location 块现在会正确处理所有子页面。
    location /dance/ {
        proxy_pass http://frontend:3000/;
        
        proxy_set_header Host $http_host; 
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # 3. 后端 API 代理 (保持不变)
    location /api/ {
        rewrite ^/api/(.*)$ /$1 break;
        proxy_pass http://backend:8005;

        proxy_set_header Host $http_host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}